
	mnews	ミニ・ニュースリーダー 便利帳&開発談 (Ver 1.21 用)

	この文書は mnews に関して知っておくとちょっとお得な情報を書いたもの
	です。

	(1) 記事のヘッダスタイルを整えたい。

	よくメールやニュースの記事の返信において無愛想な
	「In article 〜 writes:」
	の代わりに
	「〜頃〜さんが書きました。」
	などとなっている記事がありますが、mnews でも設定可能です。
	例えば ~/.mnews_setup に

	reply_message:	%Iの記事において\n%Y年%m月%d日(%W) %H時%M分%S秒頃、%F{さん,私}は書きました。\n
	follow_message:	%N の %I の\n記事において %Y年%m月%d日(%W) %H時%M分%S秒頃、\n%F{さん,私}は書きました。\n

	などと書いておくと OK です。
	また自分にも「〜さん」がついてしまうわずらわしい問題も 1.19 では解決
	できるようになっています。

	(2) ちょっとでも高速にしたい。

	記事コードと kterm などの端末の漢字コードが一致することがわかっている
	方は ~/.mnews_setup に

	print_code:	ASCII

	と書くか -a オプションをつけて起動すると記事参照が多少高速にな
	ります。

	(3) 画面を少しでもワイドにしたい。

	せまいパソコンなどの端末でも記事一覧をもっとワイドにみたいという方は
	~/.mnews_setup に

	wide_mode:	on

	と書くか -w オプションをつけて起動すると 2 行お得です。
	たった 2 行でも低速モデムで使う人には嬉しいそうです。

	(4) ESC を通さないけど日本語 Subject を使いたい。

	~/.mnews_setup に

	x_nsubj_mode:	on

	と書くと X-Nsubject: フィールドに対応します。記事を出す時は通常通り
	Subject: には英数字で書き、X-Nsubject: には英数字または日本語で書い
	て下さい。ESC が落ちても mnews なら読めます。
	(拙作の MH もどきの MMH も X-Nsubject: に対応しています)

	(5) GNUS に似せたい。

	~/.mnews_setup に

	gnus_mode:		on
	news_thread_mode:	on

	と書いて起動すると GNUS に近くなります。
	(起動後でも変更できます)
	更に多少遅くなっても良いなら ~/.mnews_setup に

	news_article_mask	on
	sort_rule:		1

	を加えるとより近くなります。
	ただし、sort_rule パラメータは 1.19 版以降でリファレンスソートを
	サポートするコンパイルオプションをつけた時のみ使用できます。

	(6) MH, RMAIL, UCB-mail のどれかひとつだけ表示して欲しい。

	例えば MH だけ使うなら ~/.mnews_setup に

	mh_mode:	on
	ucbmail_mode:	off
	rmail_mode:	off

	と書けば OK です。

	(7) メールに勝手に自分宛の Cc: をつけて欲しくない。

	~/.mnews_setup に

	add_cc_mode:	off

	と書けば OK です。

	(8) 出し損ねた記事を復活させたい。

	~/.message, ~/.message~, ~/dead.letter のいずれかに残っている可能性
	が高いです。

	(9) MH モードでも未読管理して欲しい。

	~/.mnews_setup に

	mh_mark_mode:	on

	と書けば OK です。デフォルトでこの機能が OFF なのは本家の MH の未読
	管理機能には問題があるためです。1.19 からは ~/.mh_profile に

	Unseen-Sequence: unseen

	と書けば MH の mark コマンドによる未読管理にも対応できますが、とても
	遅いので推奨はしません。

	(10) メールに Fcc: を使いたい。

	MH ユーザなら folder +posted または mkdir ~/Mail/posted として送信
	したメール保存用のフォルダを作成し、~/.mnews_setup に

	fcc_field:	Mail/posted

	とディレクトリ名を書けば OK です。
	  ~~~~~~~~~~~~~~
	RMAIL/UCB-mail ユーザなら ~/.mnews_setup に

	fcc_field:	posted

	と送信したメール保存用のファイル名を書けば OK です。
	                        ~~~~~~~~~~
	(11) まとめて uudecode したい。

	fj.binaries.msdos のような記事フォーマットならアーカイブの順にマルチ
	マークをつけてパイプで付属の combine.sh コマンドを実行すれば一気に
	uudecode されます。
	マルチマークはマーク順に実行されます。

	(12) MH のエイリアスファイルを使いたい。

	~/.mh_profile に AliasFile: alias-file もしくは ali: -alias alias-file
	と書いている人なら ~/.mnews_setup に

	mh_alias_mode: on

	と書き加えて下さい。
	mh_alias_mode: が off だと ~/.mailrc に書いたエイリアスが適用され
	ます。

	(13) カラー表示したい。

	カラーオプションをつけてコンパイルし、.mnews_setup に

	color_mode: on

	と書いてから mnews を起動して下さい。

	(14) もっと情報が知りたい。

	mnews-ML があります。

	echo #guide | mail mnews-request@leo.chubu.ac.jp

	でガイドを取り寄せることができます。
	現在 Web ページも作成中ですので運が良ければそのうち開設できると
	思います。

	(15) 他のツールも作ってるんですか?

	UNIX では xklock, mnews, mmh, mless が一般公開されています。
	MSDOS では mnews, mmh, mless, which, man が一般公開されています。
	X68K では上記に加え更に色々公開されています。
	公開されているものは氷山の一角で実際には 30 種類くらいのツールを
	メンテナンスしています。

開発談

	gnus の vin 化計画から始まって最初は Elisp で gnus を改造していた
	のですが、どこでどう間違ったのかニュースリーダを一から開発すること
	になってしまいました。
	mnews の作成を決心してからリリースまでは本当に時間がかかりました。
	最初に開発をはじめたのは 1991-07/25 ですから 1 年以上もかかっていま
	す。というのも開発は休み時間に行なっているのと、ついつい逃避行動に
	走ってしまって別のツール xchat, hexdump, newsreport などを作ってい
	たためです。
	それと当初 NNTP の利用方法がわからずソケット通信のプログラムは書い
	たことがなかったので時間がかかりました。(開発当初は NNTP ライブラ
	リがあるのを知らなかったので…)
	newsreport で NNTP ライブラリができてからは製作は急ピッチで進みま
	した。最初は完全に vin と同じ操作にして名称も bin にしようかと思い
	ましたが、佐藤@電総研さん(vin の作者さん)が気を悪くされてもいけ
	ないので悪のりはやめました。:-)

	mnews は vin と異なり一つのマシンに多数のユーザが同時にログインして
	使用するという劣悪な環境で動作させることを前提としているため、小型
	化と高速化には気をつけて開発しました。しかしいくら C 言語で組んでも
	ニュースグループのソートやら画面制御の負荷は結構重くなってしまいま
	したが、既存のニュースリーダの中でも処理内容の割にはかなり高速の部
	類に入ることは間違いないと思います。

	ユーザインタフェースの設計は vin と gnus ユーザが半々いると推測し、
	中間的なものにしました。実は vin ライクな階層構造のユーザインタ
	フェースは処理がとっても面倒です。ここの開発は予想以上に手間がかか
	りバグの嵐でした。
	未読記事のグループ毎カウント処理などとても面倒なのですが、mnews で
	はグループ階層を移る度に該当グループの未読記事のカウント処理を実行
	しているにもかかわらず、割合まともな速度で動きます。というか苦労し
	てまともな速度を維持してます。

	NNTP サーバの負荷についてはかなり考慮しました。mnews では余分なト
	ラフィックは極力避けるように処理していますが、記事ヘッダのキャッ
	シュはたった 1 グループ分しか持っておらず、それも必要なだけしか確
	保しません。キャッシュ量を増やせば多少高速になりますが、効果の割に
	メモリの消費量が馬鹿にならないからです。
	ただし、既読記事の非表示は後から考えた仕様なので 'L', 'l', 't', 'T'
	などのコマンドを使用すると一旦キャッシュはクリアされます。(つまり
	無駄な通信が行なわれます)

	ニュースグループを選択してからサブジェクト一覧の表示が他のニュース
	リーダよりも高速な理由は表示前に全記事を検索するのではなく、表示す
	る時に必要最低限を検索するためです。一度表示した部分はグループを移
	らない限りキャッシュに保持しており無駄な通信を避けています。ただし
	スレッドモードでは遡って記事をソートする必要があるためにこの限りで
	はありません。

	tin というニュースリーダでは高速なかわりに作業ファイルをいっぱい作
	りますが、ディスク不足の環境下で使われることを想定して mnews では
	.newsrc 以外の設定ファイルを基本的に必要としません。mnews を一度起
	動すると .newsrc は自動的に最適化されます。新規のニュースグループは
	自動的に追加され、Bogus (無効)なニュースグループや致命的エラーの
	あった行は自動で抹消されるので完全にメンテナンスフリーです。ただ
	gnus と併用すると .newsrc.el とかと整合が取れなくなりますが、そもそ
	もこれは .newsrc 以外に未読情報の保存しているソフトの方が反則だと
	思いますし環境変数 MNEWSRC で逃げられるので、さして問題ではないで
	しょう。また 1.12 版からは新規のニュースグループを除き .newsrc の
	自動ソートを行なわないようにしましたのでトラブルは減っています。

	それからこまごまとした設定をオプションでなく設定ファイルにしたいと
	いう要望が強かったので 1.00 版からは .mnews_setup というファイルに
	も対応しました。(本当はやりたくなかったのですがニーズがあるもので)

	メールについては当初はサポートする予定がなかったのですが、vin ユー
	ザがメールを扱えないとなかなか移行してくれそうにないので仕様追加し
	ました。MH はコマンドを呼び出せばいいので割合実装は簡単なのですが、
	mbox や RMAIL はそうはいきません。ucb-mail では未読管理は mbox 形
	式のフォーマットの一部として扱っていますが、これを真似すると結構
	しんどいので vin ではどうしているのかなと思って調べたら .vinrc で
	扱うという逃げをしているようです。(私は vin ユーザではないので詳
	しくは知りません。)
	mnews では mbox, RMAIL ファイル中にそれぞれのフォーマットに従って
	未読情報を埋め込んでいます。MH に関しては独自にフィールドを追加し
	て逃げていますが、勝手に記事ファイルを触られるのは困るというユーザ
	が多いと思いますのでデフォルトでは MH に限り未読管理をしません。
	また 1.19 版からは MH の mark コマンドによるマーク機能にも対応して
	います。(でも MH の mark は refile に対応できないし、遅いのでお勧
	めできません。)

	内蔵ページャーですが、当初は内蔵しておらず less を起動していまし
	た。しかしイチイチ q キーに手を伸ばすのは面倒、less をインストール
	していないと動かないなどの問題があったので渋々 less 下位互換のペー
	ジャーを開発して内蔵しました。漢字コード自動判別/変換、^L への対
	応など開発にはかなり地獄をみました。この部分の設計がタコなため、
	最初は 1 ファイルしか扱えず、? でヘルプが出なかったのですが、無理
	やり複数ファイルに対応しました。
	本家 less でもバージョンが上がると漢字コード変換などでどんどん処理
	が重くなっているのと同じような理由で内蔵ページャーはかなり鈍速です。

	画面周りの表示は当初 termlib と独自ルーチンの組合せで作成していまし
	たが、その後 curses を使うことにしました。curses を使用すると様々な
	タイプの端末に対応できるというメリットはありますが、実際は VT100 互
	換端末しかまずないですし、それ以上に curses をつけたことによる速度
	の低下、サイズの巨大化、文字の化け(curses は JLE でも EUC しか漢字
	に対応していない)が目立ちました。
	そこで現在は完全に独自ルーチンで動いており、高速化と小型化してあり
	ます。
	しかし、ここでも結局うちの端末じゃ駄目だーとおしかりを受け、最後には
	termcap にも対応するはめに陥りました。端末周りは機種の依存性が大き
	いので結構地獄です。:-)

	ファイル/フォルダ名補完処理ですが、ない知恵を絞って短い割に結構実
	用的な仕上がりになったと思います。Emacs と互換にすると処理が複雑で
	ニュースリーダに実装するには負担が大き過ぎるので簡素化しました。

	また、マルチセーブ、パイプ実行機能は fj.binaries.msdos が ish 対応
	にならなかった腹いせにつけた機能です。(というのは冗談ですが:-)

	MIME ですが、私はヘッダを MIME でエンコードするのは嫌いです。audio
	&visual に MIME を活用する分には構わないと思いますが、日本語が画像
	データと同列にわけのわからんコードで表されるのは納得いきません。
	わざわざ JIS で通るところを何故エンコードしなければならないのでしょ
	うか?
	MIME でエンコードすると日本語 Subject なら最悪 1 行だったものが 10
	行近くに膨れ上がります。しかも受信した相手が対応したリーダを使って
	いるかどうかも確かめずにいきなり送りつける悪い習慣がはやっています。
	mnews でもこういった MIME を喜んで使う困った人による被害が無視でき
	なくなったので基本路線はデコードのみ対応としました。エンコードの
	ルーチンも入っていますが、嬉しくないのであんまり使って欲しくはあり
	ません。

	さて、1.18 で行なった MS-DOS 対応ですが、私は 1.19 の開発の半ばまで
	DOS マシンを普段使っていませんでしたし MS-DOS マシン用のネットワーク
	カードもコンパイラも未だ持っていないので難航しました。この部分の対応
	コードは MS-C に近い X68000 の GCC+libc で動くように書き、後はα、
	βテストにおいて DOS ユーザさんからの暖かい協力によるパッチ情報を
	元に作成されています。通信部分については著作権がらみの問題が発生する
	と困るので沢田@ムライ電気さんの作成された inetbios を許可を頂き、
	無変更で使うこととしています。

	1.20 では PC-UNIX からの利用を便利にするために無理をして SMTP と POP3
	に一気に対応しました。1.20 の開発にはトラブルが続出しました。まず
	開発マシン上の FreeBSD で 2 回の悲惨なクラッシュに見舞われ再インス
	トールを余儀なくされた事、いい加減にインストールした POP サーバは正常
	に稼働しない事、そして何より本業が忙しくて時間がまるでとれない事です。

	そして今回の 1.21 ですが、目標としていた半年に 1 回のメジャーバー
	ジョンアップは遅れに遅れ、1 年ほどたってしまいました。しかも目標に
	かかげていたドラフト機能はできていない始末。MIME のバイナリデータも
	受信のみというなんとも情けない限りですが、こんなツールでもよければ
	使って下さい。

	参考文献として色々 RFC などを使用しましたが、mnews では決してきっち
	り RFC を守っているわけではありません。重要そうな部分はだいたい守っ
	たつもりですが、そもそもテストに使用している nntpd からしてきっちり
	守っていない…というわけで、もし「これは重大なルール違反だ!」
	という部分があったら無知な作者まで教えて下さい。

連絡先

	Matsushita Soft-Research, INC.	Akira Takuma	宅間 顯
	E-mail	takuma@msr.mei.co.jp
